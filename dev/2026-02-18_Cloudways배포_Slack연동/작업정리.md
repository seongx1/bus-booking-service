# 2026-02-18 작업 정리: Cloudways 배포 + Slack 연동

## 개요

- **Cloudways** 서버(1574100)에 **Korea bus charter** 앱 생성 후 홈페이지 배포
- **Get a Quote** 폼 제출 시 **Slack**으로 메시지 전달되도록 설정 및 수정

---

## 1. Cloudways

### API/CLI

- **가이드:** `docs/CLOUDWAYS_API_CLI_GUIDE.md`
- **스크립트:** `scripts/cloudways-api.sh`
  - `servers` — 서버 목록
  - `apps <server_id>` — 앱 목록
  - `create-app <server_id> "앱 이름"` — 기존 서버에 앱 추가 (phpstack 8.1)
- **인증:** 대시보드 → API Integration → Generate Key (이메일 + API 키)
- 파일 업로드는 API 미지원 → SFTP 사용

### 앱 생성

- 서버 ID: **1574100** (Travle)
- API로 앱 추가: `POST /api/v1/app`  
  - `server_id`, `application`: phpstack, `app_version`: 8.1, `app_label`: Korea bus charter
- 앱 정보: `scripts/upload_sftp.py` 등에서 사용 (sys_user, 경로 등)

### 배포

- **빌드:** `./scripts/build.sh` → `dist/` 생성, `.htaccess` 복사
- **업로드:** `scripts/upload_sftp.py` (paramiko)  
  - 마스터 계정 SFTP, 경로: `/applications/tjjsevvqfe/public_html`
  - venv: `.venv_deploy` (paramiko 설치용, .gitignore 포함)
- **임시 URL:** https://phpstack-1574100-6221145.cloudwaysapps.com/

---

## 2. Slack (Get a Quote)

### 수정 사항

- **submitButton ReferenceError**  
  - 원인: 웹훅 미설정 시 early return에서 `submitButton` 사용하는데, 선언은 그 아래에 있음  
  - 조치: `submitButton`, `originalButtonText`를 폼 핸들러 **맨 앞**에서 한 번만 선언하고, early return·finally에서 동일 변수 사용
- **대상 파일:**  
  `src/html/index_v2.html`, `index_v2_ko.html`, `index_v2_ja.html`, `index_v2_zh.html`

### 웹훅 URL

- 소스 4개 HTML의 `SLACK_WEBHOOK_URL` 에 직접 설정 (빌드 시 dist 로 복사)
- 기존 URL 404 → 새 Incoming Webhook URL로 교체
- **웹훅 URL:** 저장소에는 포함하지 않음. 배포 시 `src/html/index_v2*.html` 의 `YOUR_WEBHOOK_URL_HERE` 를 실제 URL로 교체 후 빌드·업로드.
- **가이드:** `docs/SLACK_웹훅_간단가이드.md` (웹훅 만드는 방법)

### 테스트

- curl 로 새 웹훅 URL에 POST → `ok` (HTTP 200) 확인
- 홈페이지 Get a Quote 제출 시 해당 Slack 채널로 문의 내용 전달됨

---

## 3. 참고 경로/파일

| 구분 | 경로/파일 |
|------|-----------|
| Cloudways API 가이드 | `docs/CLOUDWAYS_API_CLI_GUIDE.md` |
| Cloudways API 스크립트 | `scripts/cloudways-api.sh` |
| SFTP 업로드 스크립트 | `scripts/upload_sftp.py` |
| Slack 웹훅 간단 가이드 | `docs/SLACK_웹훅_간단가이드.md` |
| 배포용 빌드 | `./scripts/build.sh` 후 `dist/` |
| 웹훅 설정 소스 | `src/html/index_v2*.html` (4개) |

---

## 4. 재배포 절차 (참고)

```bash
./scripts/build.sh
cp .htaccess dist/
.venv_deploy/bin/python3 scripts/upload_sftp.py <host> <master_user> <master_pass> dist /applications/tjjsevvqfe/public_html
```

마스터 계정·비밀번호는 API로 서버 조회 시 확인 가능 (`scripts/cloudways-api.sh servers`).
